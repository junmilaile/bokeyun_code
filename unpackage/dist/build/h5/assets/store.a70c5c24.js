import{D as e,a6 as s,av as i,z as t,T as n,R as o,a2 as r,A as a,P as u,af as l,C as d,M as c,Q as g}from"./index-6f7f74a6.js";const p={debug:!1,isAdmin:!1,loginTypes:["weixin","username","smsCode"],agreements:{serviceUrl:"https://xxx",privacyUrl:"https://xxx",scope:["register","login","realNameVerify"]},appid:{weixin:{h5:"wxd5b8b80b234a5d6e",web:"wxd5b8b80b234a5d6e"}},passwordStrength:"medium",setPasswordAfterLogin:!1},f=e.importObject("uni-id-co"),h=e.database().collection("uni-id-users");let w=s("uni-id-pages-userInfo")||{},m=e.getCurrentUserInfo().tokenExpired-Date.now();m<=0&&(w={});const I={async updateUserInfo(s=!1){if(s)h.where("_id==$env.uid").update(s).then((e=>{e.result.updated?(t({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(s)):t({title:"没有改变",icon:"none",duration:3e3})}));else{const s=e.importObject("uni-id-co",{customUI:!0});try{let e=await h.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file,register_date").get();const i=await s.getRealNameInfo();this.setUserInfo({...e.result.data[0],realNameAuth:i})}catch(i){this.setUserInfo({},{cover:!0}),console.error(i.message,i.errCode)}}},async setUserInfo(e,{cover:s}={cover:!1}){let i=s?e:Object.assign(x.userInfo,e);return x.userInfo=Object.assign({},i),x.hasLogin=0!=Object.keys(x.userInfo).length,n("uni-id-pages-userInfo",x.userInfo),e},async logout(){if(e.getCurrentUserInfo().tokenExpired>Date.now())try{await f.logout()}catch(s){console.error(s)}o("uni_id_token"),n("uni_id_token_expired",0),r({url:"/pages/self/self"}),a("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(e={}){const{uniIdRedirectUrl:s=""}=e;let i=0,t=u();if(t.forEach(((e,s)=>{"login"==t[t.length-s-1].route.split("/")[3]&&i++})),s)return r({url:s,fail:e=>{l({url:s,fail:s=>{console.log(e,s)}})}});if("weixin"==e.loginType)return window.history.go(-3);if(i){const e=d.pages[0];return c({url:`/${e.path}`})}g({delta:i})},loginSuccess(e={}){const{showToast:s=!0,toastText:i="登录成功",autoBack:n=!0,uniIdRedirectUrl:o="",passwordConfirmed:u}=e;if(s&&t({title:i,icon:"none",duration:3e3}),this.updateUserInfo(),a("uni-id-pages-login-success"),p.setPasswordAfterLogin&&!u)return r({url:o?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${o}&loginType=${e.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,fail:e=>{console.log(e)}});if(n){let e=o;e="/pages/index/index",this.loginBack({uniUrl:e})}}},x=i({userInfo:w,hasLogin:0!=Object.keys(w).length&&m>0});export{p as c,I as m,x as s};
